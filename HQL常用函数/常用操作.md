### 1. 读取Json串

```sql
CREATE TEMPORARY FUNCTION urldecode AS 'com.hiido.hive.udf.URLDecodeOnAllUDF';
SELECT uid,
       get_json_object(urldecode(moreinfo),'$.room_id') AS room_id,
       get_json_object(urldecode(moreinfo),'$.tab_id') AS tab
FROM xunhuan.xh_mbsdkprotocol_original
WHERE eventid=20029117
```

2. row_number

```sql
INSERT OVERWRITE TABLE persona.hagoparty_uid_gift_rank PARTITION (dt='${date}')
select uid,anchor_uid,prop_cnt,total_price from (
    select uid,anchor_uid,prop_cnt,total_price,row_number() over(partition by uid,anchor_uid order by total_price desc,prop_cnt desc) as rk from (
        select uid,anchor_uid,sum(prop_cnt) as prop_cnt,sum(total_price) as total_price from (
            SELECT uid
            ,anchor_uid
            ,prop_cnt
            ,prop_price * prop_cnt as total_price
            ,get_json_object(urldecode(expand),'$.gameId') AS gameid
            FROM turnover.in_hago_props_used_rec_for_stat WHERE dt='${date}'
        ) a
        group by uid,anchor_uid
    ) b 
) c
where rk <= 5
```

